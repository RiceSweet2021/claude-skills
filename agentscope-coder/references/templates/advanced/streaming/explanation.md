# 流式输出教程

## 核心概念

流式输出（Streaming）是指 AI 模型在生成响应时，边生成边返回内容的技术。相比传统的"等待完整生成后一次性返回"，流式输出具有以下优势：

1. **更低延迟**：用户不需要等待完整生成，首字响应时间更短
2. **更好体验**：模拟真人对话的自然节奏
3. **实时反馈**：用户可以提前看到内容，决定是否中断
4. **视觉吸引力**：打字机效果增加交互趣味性

流式输出适合聊天机器人、代码助手、内容生成等场景。

---

## 代码解析

### 知识点 1：启用流式输出

**核心代码：**
```python
agent = ChatAgent(
    name="assistant",
    model_config_name="qwen-max",
    stream=True  # 启用流式输出
)

# 使用 stream() 方法
for chunk in agent.stream("你的问题"):
    print(chunk, end="", flush=True)
```

**解析：**

启用流式输出的关键：

1. **stream=True**：创建 Agent 时启用流式模式
2. **agent.stream()**：使用流式方法而不是直接调用
3. **flush=True**：确保每个字符立即显示

### 知识点 2：流式 vs 非流式对比

| 特性 | 非流式 | 流式 |
|------|--------|------|
| 响应方式 | 等待完整生成后返回 | 边生成边返回 |
| 首字延迟 | 较高（需等待完整生成） | 较低（首字快速显示） |
| 用户体验 | 一次性显示所有内容 | 逐步显示，更自然 |
| 中断能力 | 无法提前中断 | 可随时停止 |

### 知识点 3：流式输出处理

**核心代码：**
```python
char_count = 0
start_time = time.time()

for chunk in agent.stream(question):
    print(chunk, end="", flush=True)
    char_count += len(chunk)

    # 显示进度
    if char_count % 100 == 0:
        speed = char_count / (time.time() - start_time)
        print(f"\n[进度: {char_count} 字, {speed:.0f} 字/秒]")
```

**解析：**

流式输出时可以添加：

| 功能 | 实现 |
|------|------|
| 进度显示 | 定期打印已生成字符数 |
| 速度统计 | 计算字符生成速度 |
| 高亮标记 | 特定内容添加格式 |

---

## 关键知识点总结

| 知识点 | 要点 |
|--------|------|
| stream=True | 创建 Agent 时启用流式模式 |
| agent.stream() | 使用流式方法，返回迭代器 |
| flush=True | 确保内容立即显示 |
| 首字延迟 | 流式输出显著降低首字响应时间 |

---

## 使用建议

| 场景 | 是否使用流式 |
|------|-------------|
| 聊天对话 | ✅ 推荐 |
| 代码生成 | ✅ 推荐 |
| 批量处理 | ❌ 非必要 |
| API 调用 | 根据需求 |

---

## 练习题

1. 实现一个带打字机音效的流式输出
2. 添加流式输出的暂停/恢复功能
3. 对比不同模型在流式输出下的首字延迟差异
